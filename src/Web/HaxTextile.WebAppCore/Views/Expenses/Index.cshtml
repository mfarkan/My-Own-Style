@{
    Layout = "_AdminLayout";
}
@using Core.Enumarations
@using HaxTextile.WebAppCore.Models.Expense
@model ExpenseSearchRequestDTO
<title>Gelir/Gider İşlemleri</title>
<script src="~/jQueryDataTable/jquery.dataTables.min.js"></script>
<div class="container-fluid">
    <div class="col-md-12">
        <div class="row">
            <div class="col-12 grid-margin">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Gelir/Gider İşlemleri</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Müşteri Ad:</label>
                                    <div class="col-sm-8">
                                        @Html.DropDownListFor(q => q.CustomerId, new SelectList(Model.CustomerList, "Id", "CustomerName"), "Seçiniz.", new { @class = "form-control" })
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Gelir/Gider Bilgisi</label>
                                    <div class="col-sm-8">
                                        @Html.DropDownListFor(q => q.ExpenseType, Html.GetEnumSelectList<ExpenseType>(), "Seçiniz.", new { @class = "form-control" })
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Gider Açıklaması</label>
                                    <div class="col-sm-8">
                                        <input type="text" asp-for="Description" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Dök. Numarası</label>
                                    <div class="col-sm-8">
                                        <input type="text" asp-for="DocumentNumber" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Vade Gün Sayısı</label>
                                    <div class="col-sm-8">
                                        <input type="number" asp-for="Expiry" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Vade Tarihi</label>
                                    <div class="col-sm-8">
                                        <input type="date" asp-format="{0:dd/MM/yyyy}" asp-for='ExpiryDate' class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-info" id="searchButton"><i class="fa fa-search"></i> Filtrele</button>
                                <button class="btn btn-info" asp-controller="Expenses" asp-action="Create" asp-route-expenseType="@(ExpenseType.InCome)" type="button" id="newIncomeButton"><i class="fa fa-plus"></i> Gelir Girişi</button>
                                <button class="btn btn-info" asp-controller="Expenses" asp-action="Create" asp-route-expenseType="@(ExpenseType.OutGoing)" type="button" id="newOutcomeButton"><i class="fa fa-plus"></i> Gider Girişi</button>
                            </div>
                        </div>
                        <br />
                        <div class="col-md-12">
                            <table id="datatable-ExpenseList" class="table table-striped table-bordered dt-responsive nowrap tableSC" cellspacing="0" width="100%">
                                <thead>
                                    <tr class="text-center">
                                        <th>Müşteri Adı</th>
                                        <th>Tutarı</th>
                                        <th>Vade</th>
                                        <th>Vade Tarihi</th>
                                        <th>Açıklama</th>
                                        <th>Dök. Numarası</th>
                                        <th style="width:80px;">#</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script type="text/javascript">
        function Update(id) {
            window.location = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/Expense/Update?Id=" + id;
        }
        function Delete(id) {
            $.ajax({
                url: 'Expenses/DeleteExpense/' + id,
                type: 'DELETE',
                success: function (result) {
                    console.log(result);
                    swal.fire({
                        type: 'success',
                        title: 'Başarılı',
                        confirmButtonText: 'Kapat',
                        text: 'Silme işlemi başarıyla gerçekleşti.'
                    }).then((result) => {
                        if (result.value) {
                            DataListGrid.draw();
                        }
                    });
                },
                error: function (result) {
                    swal.fire({
                        type: 'error',
                        title: 'Hata',
                        text: 'Silme işlemi sırasında hata gerçekleşti.'
                    });
                }
            });
        }
        var DataListGrid = null;
        function fillDataList() {
            if (DataListGrid != null)
                DataListGrid.destroy();
            var grid = $('#datatable-ExpenseList').DataTable({
                "destroy": true,
                "processing": true,
                "info": false,
                "serverSide": true,
                "ordering": false,
                "searching": false,
                "ajax": {
                    "url": 'http://localhost:55467/Expenses/ExpenseList',
                    "dataSrc": 'expenses',
                    cache: false,
                    "data": function (data) {
                        data.CustomerId = $('#CustomerId').val();
                        data.ExpenseType = $('#ExpenseType').val();
                        data.Description = $('#Description').val();
                        data.DocumentNumber = $('#DocumentNumber').val();
                        data.Expiry = $('#Expiry').val();
                        data.ExpiryDate = $('#ExpiryDate').val();
                    },
                },
                "columns": [
                    { "data": "Customer.CustomerName" },
                    {
                        "data": function (data, type, dataToSet) {
                            switch (data.Type) {
                                case 1:// gider
                                    return "<p class='text-danger'>" + data.Amount + ' ' + data.CurrencyType + "</p>"
                                    break;
                                case 2://gelir
                                    return "<p class='text-success'>" + data.Amount + ' ' + data.CurrencyType + "</p>"
                                    break;
                                default:
                            }
                        }
                    },
                    { "data": "Expiry" },
                    { "data": "ExpiryDate" },
                    { "data": "Description" },
                    { "data": "DocumentNumber" },
                    { "data": "#" }
                ],
                "language": {
                    "url": "/json/Turkish.json"
                },
                drawCallback: function (settings) {
                    var pagination = $(this).closest('.dataTables_wrapper').find('.dataTables_paginate');
                    pagination.toggle(this.api().page.info().pages > 10);
                },
                "columnDefs": [{
                    "targets": -1,
                    "data": null,
                    "defaultContent":
                        "<button type='button' id='updateButton' class='btn btn-link'><i class='fas fa-pen-alt'></i></button>" +
                        "<button type='button' id='deleteButton' class='btn btn-link'><i class='far fa-trash-alt'></i></button>"
                }
                    //{
                    //    targets: [2],
                    //    render: function (data, type, row) {
                    //        switch (data) {
                    //            case 1:
                    //                return 'Tüzel';
                    //            case 2:
                    //                return 'Şahıs';
                    //            default:
                    //        }
                    //    }
                    //}
                ]
            });
            DataListGrid = grid;
        };
        $(document).ready(function () {
            fillDataList();
            $('#datatable-ExpenseList').on('click', '#updateButton', function (e) {
                var data = DataListGrid.row($(this).parents('tr')).data();
                Update(data["id"]);
            });
            $('#datatable-ExpenseList').on('click', '#deleteButton', function (e) {
                var data = DataListGrid.row($(this).parents('tr')).data();
                Delete(data["id"]);
            });
            $('#searchButton').click(function () {
                fillDataList();
            });
        });
    </script>
}